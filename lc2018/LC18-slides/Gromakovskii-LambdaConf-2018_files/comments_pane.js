define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","spectrum_comments/comment_stream","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/legacy_annotations_bridge","modules/clean/react/comments2/util","modules/clean/react/comments2/util","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/actions","modules/clean/react/comments2/data/mentions_api","modules/clean/react/file_viewer/coach_mark","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/previews/constants","spectrum_comments/comment/time_coded_comment","spectrum_comments/comment/numbered_comment","spectrum_comments/comment_editor/editor_with_coach_mark","modules/clean/react/comments2/video_annotations/constants","modules/clean/react/comments2/video_annotations/video_preview_event_emitter","modules/core/i18n","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/data/frame_message_listener","modules/clean/react/comments2/util"],function(e,t,o,n,i,r,s,a,c,m,d,p,l,u,h,v,b,g,_,f,w,C,y,E,O,T,M,A,S){"use strict";function P(e){var t=e.previewType,o=e.onCoachMarkClose;return t&&[f.PreviewType.Audio,f.PreviewType.Video].includes(t)?n.default.createElement(v.CoachMark,{title:T._("Target your feedback"),arrowPosition:"top-right",showClose:!0,onCloseButtonClick:o},T._("Adding time codes to comments keeps feedback simple, organized, and all in one place.")):n.default.createElement(v.CoachMark,{title:T._("Want to comment?"),arrowPosition:"top-right",showClose:!0,onCloseButtonClick:o},T._("@mention someone to work together on this file"))}function D(e){var t=e.playerCurrentTime,i=void 0===t?0:t,r=e.pendingDocOrImageAnnotation,s=e.previewType,a=e.showOnboarding,c=e.onCoachMarkClose,m=a?n.default.createElement(P,{previewType:s,onCoachMarkClose:c}):void 0;return s===f.PreviewType.Audio?n.default.createElement(y.TimeCodedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:{type:"audio",time:i},coachMark:m})):s===f.PreviewType.Video?n.default.createElement(y.TimeCodedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:{type:"video",time:i},coachMark:m})):s!==f.PreviewType.Doc&&s!==f.PreviewType.Photo||!r?n.default.createElement(y.CommentEditorWithCoachMark,o.__assign({},e,{coachMark:m})):n.default.createElement(y.NumberedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:r,coachMark:m}))}Object.defineProperty(t,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),l=o.__importStar(l),S=o.__importStar(S);var I=(function(e){function t(t){var i=e.call(this,t)||this;i.onCommentStreamRef=function(e){return i.commentStream=e},i.updateMentionsMatches=function(e){i.setState({mentionsMatches:e})},i.onMentionsQueryUpdated=function(e){i.mentionsApi.query(e,i.updateMentionsMatches)},i.videoPreviewOnboardingDismissed=function(){i.props.dispatch(u.Actions.suppressOnboardingForSession("video_first_paused"))},i.toggleShowResolved=function(){var e=i.props,t=e.dispatch,o=e.showResolved,n=o?"hide_resolved_threads":"show_resolved_threads";t(u.Actions.toggleShowResolved()),t(u.Actions.logEvent(n))},i.setCommentsEnabled=function(){i.props.dispatch(u.Actions.enableCommenting())},i.setCommentsDisabled=function(){i.props.dispatch(u.Actions.disableCommenting())},i.createEditor=function(e){var t=i.props,r=t.playerCurrentTime,s=t.pendingDocOrImageAnnotation,a=t.showOnboarding,c=t.stream.previewType;return n.default.createElement(D,o.__assign({},e,{pendingDocOrImageAnnotation:s,playerCurrentTime:r,previewType:c,showOnboarding:a,onCoachMarkClose:i.onCoachMarkClose}))},i.onCoachMarkClose=function(){var e=i.props.stream.previewType;e===f.PreviewType.Audio||e===f.PreviewType.Video?i.props.dispatch(u.Actions.suppressOnboardingForSession("initial_video_land")):e!==f.PreviewType.Doc&&e!==f.PreviewType.Photo&&i.props.dispatch(u.Actions.suppressOnboardingForSession("initial_non_annotation_land")),d.markBrowserHasDismissedOnboardingPopup(i.props.stream)};var r=t.viewer,s=t.dispatch;return i.mentionsApi=h.mentionsApi(r),S.isComments2ImageAnnotationsEnabled(r)&&(i.frameMessageListener=new A.FrameMessageListener(s)),i.state={mentionsMatches:i.mentionsApi.cache},i}return o.__extends(t,e),t.prototype.buildResolveOption=function(){var e=this.props.showResolved?g.FileActionButtonType.HIDE_RESOLVED_COMMENTS:g.FileActionButtonType.SHOW_RESOLVED_COMMENTS;return new _.MoreOption({className:"comments-options-item__show-resolved",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:this.toggleShowResolved})},t.prototype.buildEnableOption=function(){var e,t;return this.props.isEnabled?(e=g.FileActionButtonType.DISABLE_COMMENTS,t=this.setCommentsDisabled):(e=g.FileActionButtonType.ENABLE_COMMENTS,t=this.setCommentsEnabled),new _.MoreOption({className:"comments-options-item__disable",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.buildSubscribeOption=function(){var e,t,o=this;return this.props.isSubscribed?(e=g.FileActionButtonType.UNSUBSCRIBE,t=function(){return o.props.dispatch(u.Actions.unsubscribe(void 0))}):(e=g.FileActionButtonType.SUBSCRIBE,t=function(){return o.props.dispatch(u.Actions.subscribe(void 0))}),new _.MoreOption({className:"comments-options-item__subscribe",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.updateCommentsMoreOptionGroup=function(){var e=[];m.canComments2EnableDisable(this.props.viewer)&&this.props.canEnable&&e.push(this.buildEnableOption()),e.push(this.buildResolveOption()),m.canComments2SubscribeUnsubscribe(this.props.viewer)&&this.props.canSubscribe&&e.push(this.buildSubscribeOption());var t=new _.MoreOptionGroup({fileActionButtonGroup:g.FileActionButtonGroup.COMMENTS,options:e});void 0===this.moreOptionGroup?b.moreOptionRegistry.addOption(t):b.moreOptionRegistry.replaceOption(this.moreOptionGroup,t),this.moreOptionGroup=t},t.prototype.componentDidMount=function(){this.updateCommentsMoreOptionGroup(),O.videoPreviewEventEmitter.addListener(E.EventTypes.ONBOARDING_DISMISSED,this.videoPreviewOnboardingDismissed);var e=this.props,t=e.dispatch,o=e.showOnboarding;t(u.Actions.logEvent("show_comments"));var n=d.hasBrowserDismissedOnboardingPopup(this.props.stream)&&Math.random()<.8;t(u.Actions.setSoftHideCommentsPaneOnboarding(n)),o&&!n&&t(u.Actions.logEvent("sidebar_onboarding_shown"))},t.prototype.componentDidUpdate=function(e){var t=this.props,o=t.showOnboarding,n=t.dispatch;this.updateCommentsMoreOptionGroup(),!e.showOnboarding&&o&&n(u.Actions.logEvent("sidebar_onboarding_shown")),!e.requestEditorFocus&&this.props.requestEditorFocus&&(this.commentStream.focusPrimaryEditor(),n(u.Actions.fulfillEditorFocusRequest()))},t.prototype.componentWillUnmount=function(){this.moreOptionGroup&&b.moreOptionRegistry.removeOption(this.moreOptionGroup),O.videoPreviewEventEmitter.removeListener(E.EventTypes.ONBOARDING_DISMISSED,this.videoPreviewOnboardingDismissed)},Object.defineProperty(t.prototype,"actionsAdapter",{get:function(){var e=this.props,t=e.dispatch,o=e.onboardingKeysToMark,n=e.stream,i=e.viewer,r=e.pendingDocOrImageAnnotation;return a.createActionsAdapter(t,n,o,this.onMentionsQueryUpdated,this.frameMessageListener,i,r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"commentComponent",{get:function(){switch(this.props.stream.previewType){case f.PreviewType.Video:case f.PreviewType.Audio:return w.TimeCodedComment;case f.PreviewType.Photo:case f.PreviewType.Doc:return C.NumberedComment;default:return}},enumerable:!0,configurable:!0}),t.prototype.render=function(){var e,t=this.props,o=t.showResolved,i=t.isMobile,r=t.stream,a=t.viewer,d=t.activeThreadId,l=t.hoverThreadId,u=this.props.threads.filter(function(e){return o||!e.resolved});return a&&(e=p.dbxUserToIUser(a)),n.default.createElement("div",{className:"comments-pane-wrapper"},n.default.createElement(s.CommentStream,{ref:this.onCommentStreamRef,id:r.id,actionsAdapter:this.actionsAdapter,commentComponent:this.commentComponent,editorComponent:this.createEditor,enabled:!0,isMobile:!!i,mentionsMatches:this.state.mentionsMatches,settings:{canAnnotate:!0,canComment:!0,canRead:!0},userPermissions:{canAnnotate:!0,canComment:!0,canRead:!0},threads:u,user:e,activeThreadID:d,hoverThreadID:l,showUnreadPill:m.canShowUnreadPill(a),localization:M.commentsMasterLocalization}),this.frameMessageListener&&n.default.createElement(c.LegacyAnnotationsBridge,{frameMessageListener:this.frameMessageListener}))},t})(n.default.Component);t.CommentsPaneComponent=I;var k=i.connect(function(e){var t=l.getContext(e),o=t.stream,n=t.viewer;return{activeThreadId:l.getActivatedThreadId(e),hoverThreadId:l.getHoverThreadId(e),playerCurrentTime:l.getPlayerCurrentTime(e),onboardingKeysToMark:l.getOnboardingKeysUnmarkedForStream(e,o),showOnboarding:l.getShowOnboardingOnCommentsPane(e),showResolved:l.getShowResolved(e),canEnable:l.getCanEnable(e),isEnabled:l.getIsEnabled(e),canSubscribe:l.getCanSubscribe(e),isSubscribed:l.getIsSubscribed(e),pendingDocOrImageAnnotation:l.getPendingDocOrImageAnnotation(e),stream:o,threads:l.getThreads(e),viewer:n,requestEditorFocus:l.getIsEditorFocusRequested(e)}})(I);t.CommentsPane=r.requireCssWithComponent(k,["/static/js/spectrum_comments/index.web-vflJ2EvjI.css","/static/css/comments2-sidebar-vflgutHI9.css"])});
//# sourceMappingURL=comments_pane.min.js-vflxeQbHc.map